{{#each errors}}
<div class="alert alert-danger">{{texto}}</div>
{{else}}

{{/each}}

<h2 class="title-page"><span style="color: var(--just-colors-006, #F90196);">+</span> Add Dash</h2>
<p class="breadcrumb"><a href="/" style="text-decoration: none !important; color:inherit">Home</a> <span
        style="color:#F90196">&nbsp;/&nbsp;</span> Novo dashboard</p>

<div class="container container-dashboards">

    <form class="mt-4" action="/dashboards/new" method="POST">
        <div class="row">
            <div class="col-12 col-md-4">
                <div class="row">
                    <div class="col-6">
                        <label for="customer">Cliente</label>
                        <select class="form-select form-control" id="customer" name="customer" required>
                            <option value="" disabled selected hidden>Selecionar</option>
                            {{#each customers}}
                            <option value="{{id_customer}}">{{name_customer}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <div class="col-6">
                        <label for="customer">BU</label>
                        <select class="form-select form-control" id="bu" name="bu" required>
                            <option value="" disabled selected hidden>Selecionar</option>
                            <option value="1">Opção 1</option>
                            <option value="2">Opção 2</option>
                            <option value="3">Opção 3</option>
                            <option value="4">Opção 4</option>
                        </select>
                    </div>
                </div>
                <label for="objective" class="mt-4">Objetivo do Dash</label>
                <textarea rows="5" cols="50" id="objective" name="objective_project" class="form-control"
                    required></textarea>
            </div>
            <div class="col-12 col-md-4">
                <label for="project">Projeto</label>
                <select class="form-select form-control" id="project" name="project" required>
                    <option value="" disabled selected hidden>Selecione um projeto</option>
                </select>

                <label for="status" class="mt-4">Status</label>
                <select class="form-select form-control" aria-label="Status" id="des_status" name="des_status"
                    class="form-control" required>
                    <option value="" disabled selected hidden>Selecionar</option>
                    <option value="desenvolvimento">Em desenvolvimento</option>
                    <option value="homolog interna">Homologação interna</option>
                    <option value="homolog externa">Homologação externa</option>
                    <option value="publicado">Publicado</option>
                    <option value="desabilitado">Desabilitado</option>
                    <option value="expirado">Expirado</option>
                </select>

                <label for="dat_expiration" class="mt-4">Data expiração:</label>
                <input type="text" name="dat_expiration" id="dat_expiration" class="form-control"
                    placeholder="Selecionar" onfocus="(this.type='date')" onblur="(this.type='text')">
            </div>
            <div class="col-12 col-md-4">
                <label for="title">Nome do Dash</label>
                <input class="form-control" type="text" id="title" name="title" required>

                <label for="link_documentation" class="mt-4">Link da Documentação</label>
                <input class="form-control" type="text" id="link_documentation" name="link_documentation">
            </div>
        </div>
        <button class="btn btn-primary btn-addurl-mobile" type="button" id="addUrlFieldMob">Add Dash +</button>
        <div class="mt-4 " id="urlFields">
            <div class="row row-url-fields">

                <div class="col-12 col-md-3">
                    <label for="input_format">Forma de input</label>
                    <select class="form-select form-control" id="input_format" name="dashboardUrls[][input_format]"
                        required>
                        <option value="" disabled selected hidden>Selecionar</option>
                        <option value="PWBI">PWBI</option>
                        <option value="Tableu">Tableu</option>
                        <option value="Looker">Looker</option>
                        <option value="Figma">Figma</option>
                        <!--  <option value="Imagem">Imagem</option> -->
                        <option value="URL Genérica">URL Genérica</option>
                        <option value="Python">Python</option>
                        <option value="Bloco">Bloco</option>
                        <option value="API">API</option>
                    </select>
                </div>
                <div class="col-12 col-md-3">
                    <label for="url_dashboard">Link do Dash</label>
                    <input class="form-control" type="text" id="url_dashboard" name="dashboardUrls[][url_dashboard]"
                        required>
                    <input class="form-control" type="file" id="dashboard-image" name="dashboard-image">
                    <div class="upload-area text-center" id="step-1">
                        <span>Envio de imagem</span>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <label for="device">Dispositivo</label>
                    <input class="form-control" type="text" id="device" name="dashboardUrls[][dispositivo]" required>
                </div>
                <div class="col-3 col-btn-addurl-desktop">
                    <br>
                    <button class="btn btn-primary" type="button" id="addUrlField">Add Dash +</button>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <path
                    d="M13.5535 11.7737C13.5285 11.6354 13.4525 11.5115 13.3407 11.4264C13.2288 11.3412 13.0892 11.3011 12.9492 11.3138C12.8092 11.3265 12.679 11.3911 12.5843 11.495C12.4896 11.5989 12.4372 11.7344 12.4375 11.875V16.9397L12.4465 17.041C12.4715 17.1793 12.5475 17.3032 12.6593 17.3884C12.7712 17.4735 12.9108 17.5137 13.0508 17.501C13.1908 17.4883 13.321 17.4236 13.4157 17.3198C13.5104 17.2159 13.5628 17.0803 13.5625 16.9397V11.875L13.5535 11.7737ZM13.8989 9.34375C13.8989 9.11997 13.81 8.90536 13.6517 8.74713C13.4935 8.58889 13.2789 8.5 13.0551 8.5C12.8313 8.5 12.6167 8.58889 12.4585 8.74713C12.3003 8.90536 12.2114 9.11997 12.2114 9.34375C12.2114 9.56753 12.3003 9.78214 12.4585 9.94037C12.6167 10.0986 12.8313 10.1875 13.0551 10.1875C13.2789 10.1875 13.4935 10.0986 13.6517 9.94037C13.81 9.78214 13.8989 9.56753 13.8989 9.34375ZM22 13C22 10.6131 21.0518 8.32387 19.364 6.63604C17.6761 4.94821 15.3869 4 13 4C10.6131 4 8.32387 4.94821 6.63604 6.63604C4.94821 8.32387 4 10.6131 4 13C4 15.3869 4.94821 17.6761 6.63604 19.364C8.32387 21.0518 10.6131 22 13 22C15.3869 22 17.6761 21.0518 19.364 19.364C21.0518 17.6761 22 15.3869 22 13ZM5.125 13C5.125 11.9658 5.32869 10.9418 5.72445 9.98637C6.1202 9.03093 6.70027 8.1628 7.43153 7.43153C8.1628 6.70027 9.03093 6.1202 9.98637 5.72445C10.9418 5.32869 11.9658 5.125 13 5.125C14.0342 5.125 15.0582 5.32869 16.0136 5.72445C16.9691 6.1202 17.8372 6.70027 18.5685 7.43153C19.2997 8.1628 19.8798 9.03093 20.2756 9.98637C20.6713 10.9418 20.875 11.9658 20.875 13C20.875 15.0886 20.0453 17.0916 18.5685 18.5685C17.0916 20.0453 15.0886 20.875 13 20.875C10.9114 20.875 8.90838 20.0453 7.43153 18.5685C5.95468 17.0916 5.125 15.0886 5.125 13Z"
                    fill="#808080" />
            </svg> <span class="text-inform">Máx. 3 envios</span>
        </div>

        <button type="submit" class="btn btn-confirm-form" id="save-dashbord"
            style="display: none !important;">Enviar</button>

    </form>
    <div class="row mt-4">
        <span class="text-end">
            <button type="submit" class="btn btn-confirm-form" id="send-dashbord">Enviar</button>
        </span>
    </div>

</div>


<div id="confirm-modal" class="modal">
    <div class="modal-content text-center modal-container">
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="92" viewBox="0 0 100 92" fill="none">
                <path
                    d="M76.9231 80.5C76.9231 79.4618 76.5425 78.5634 75.7812 77.8047C75.02 77.046 74.1186 76.6667 73.0769 76.6667C72.0353 76.6667 71.1338 77.046 70.3726 77.8047C69.6114 78.5634 69.2308 79.4618 69.2308 80.5C69.2308 81.5382 69.6114 82.4366 70.3726 83.1953C71.1338 83.954 72.0353 84.3333 73.0769 84.3333C74.1186 84.3333 75.02 83.954 75.7812 83.1953C76.5425 82.4366 76.9231 81.5382 76.9231 80.5ZM92.3077 80.5C92.3077 79.4618 91.9271 78.5634 91.1659 77.8047C90.4046 77.046 89.5032 76.6667 88.4615 76.6667C87.4199 76.6667 86.5184 77.046 85.7572 77.8047C84.996 78.5634 84.6154 79.4618 84.6154 80.5C84.6154 81.5382 84.996 82.4366 85.7572 83.1953C86.5184 83.954 87.4199 84.3333 88.4615 84.3333C89.5032 84.3333 90.4046 83.954 91.1659 83.1953C91.9271 82.4366 92.3077 81.5382 92.3077 80.5ZM100 67.0833V86.25C100 87.8472 99.4391 89.2049 98.3173 90.3229C97.1955 91.441 95.8333 92 94.2308 92H5.76923C4.16667 92 2.80449 91.441 1.68269 90.3229C0.560897 89.2049 0 87.8472 0 86.25V67.0833C0 65.4861 0.560897 64.1285 1.68269 63.0104C2.80449 61.8924 4.16667 61.3333 5.76923 61.3333H33.7139L41.8269 69.4792C44.1506 71.7153 46.875 72.8333 50 72.8333C53.125 72.8333 55.8494 71.7153 58.1731 69.4792L66.3462 61.3333H94.2308C95.8333 61.3333 97.1955 61.8924 98.3173 63.0104C99.4391 64.1285 100 65.4861 100 67.0833ZM80.4688 33.0026C81.1498 34.6398 80.8694 36.0373 79.6274 37.1953L52.7043 64.0286C51.9832 64.7873 51.0817 65.1667 50 65.1667C48.9183 65.1667 48.0168 64.7873 47.2957 64.0286L20.3726 37.1953C19.1306 36.0373 18.8502 34.6398 19.5312 33.0026C20.2123 31.4453 21.3942 30.6667 23.0769 30.6667H38.4615V3.83333C38.4615 2.79514 38.8421 1.8967 39.6034 1.13802C40.3646 0.37934 41.266 0 42.3077 0H57.6923C58.734 0 59.6354 0.37934 60.3966 1.13802C61.1579 1.8967 61.5385 2.79514 61.5385 3.83333V30.6667H76.9231C78.6058 30.6667 79.7877 31.4453 80.4688 33.0026Z"
                    fill="#97CCBD" />
            </svg>
        </div>
        <div>
            <h2>Confirme seu envio:</h2>
            <p>Você selecionou documento(s) para enviar para o dash.</p>
            <div class="row">
                <div class="col-4">
                    <input id="displayInputFormat1" style="width: 100%;" disabled>
                    <input class="mt-2" id="displayInputFormat2" style="display: none;width: 100%;" disabled>
                    <input class="mt-2" id="displayInputFormat3" style="display: none;width: 100%;" disabled>
                </div>
                <div class="col-4">
                    <input id="displayUrlDashboard1" style="width: 100%;" disabled>
                    <input class="mt-2" id="displayUrlDashboard2" style="display: none;width: 100%;" disabled>
                    <input class="mt-2" id="displayUrlDashboard3" style="display: none;width: 100%;" disabled>
                </div>
                <div class="col-4">
                    <input id="displayDispositivo1" style="width: 100%;" disabled>
                    <input class="mt-2" id="displayDispositivo2" style="display: none;width: 100%;" disabled>
                    <input class="mt-2" id="displayDispositivo3" style="display: none;width: 100%;" disabled>
                </div>
            </div>
        </div>

        <br>
        <div class="row">
            <div class="col-6">
                <button class="btn btn-back-modal" id="cancel-modal">Voltar</button>
            </div>
            <div class="col-6">
                <button class="btn btn-confirm-modal" id="confirm-send">Enviar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addUrlFieldButton = document.getElementById('addUrlField');
        const urlFields = document.getElementById('urlFields');
        const btnConfirmSend = document.getElementById('confirm-send')
        const btnCancelModall = document.getElementById('cancel-modal')
        const btnSubmitForm = document.getElementById('save-dashbord')

        const confirmModal = document.getElementById('confirm-modal');
        const submitButton = document.getElementById('send-dashbord');
        var uploadArea = document.getElementById('step-1');
        var urlDashboardInput = document.getElementById('dashboard-image');
        var urlInput = document.getElementById('url_dashboard');

        const modalUploadImage = document.getElementById('modal-upload-image')
        const dropAreaImage = document.getElementById('drop-area-image')

        const confirmUploadImage = document.getElementById('confirm-modal-image')
        const uploadedImageInput = document.getElementById('uploaded-image')

        const modalOk = document.getElementById('modal-ok')
        const buttonOk = document.getElementById('button-ok')

        const cancelUploadButton = document.getElementById('cancel-upload-button')
        const sendUploadButton = document.getElementById('send-upload-button')

        const cancelConfirmUpload = document.getElementById('cancel-confirm-upload')
        const sendConfirmUpload = document.getElementById('send-confirm-upload')

        const btnUrl = document.getElementById('addUrlField')
        document.getElementById('addUrlFieldMob').addEventListener('click', () => {

            btnUrl.click()
        })




        addUrlFieldButton.addEventListener('click', function () {
            const newUrlField = document.createElement('div');
            newUrlField.classList.add('row', 'mt-4', 'row-url-fields');
            newUrlField.innerHTML = `
                            <div class="col-12 col-btn-remove-url-mobile">
                    <span style="cursor: pointer; flex: 0 0 auto;width: 25%;margin:0; padding:0;align-self: center;"
                        onclick="removeUrlField(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path
                                d="M13.6693 4H2.33594M12.5579 5.66667L12.2513 10.2667C12.1333 12.036 12.0746 12.9207 11.4979 13.46C10.9213 14 10.0339 14 8.2606 14H7.7446C5.97127 14 5.08394 14 4.50727 13.46C3.9306 12.9207 3.87127 12.036 3.75394 10.2667L3.44727 5.66667M6.33594 7.33333L6.66927 10.6667M9.66927 7.33333L9.33594 10.6667"
                                stroke="#808080" stroke-linecap="round" />
                            <path
                                d="M4.33594 4H4.40927C4.67757 3.99314 4.93755 3.90548 5.15522 3.74847C5.37289 3.59147 5.53811 3.37243 5.62927 3.12L5.65194 3.05133L5.7166 2.85733C5.77194 2.69133 5.79994 2.60867 5.8366 2.538C5.90874 2.39959 6.01228 2.27999 6.13892 2.18877C6.26557 2.09755 6.41181 2.03724 6.56594 2.01267C6.64394 2 6.73127 2 6.90594 2H9.09927C9.27394 2 9.36127 2 9.43927 2.01267C9.5934 2.03724 9.73964 2.09755 9.86629 2.18877C9.99293 2.27999 10.0965 2.39959 10.1686 2.538C10.2053 2.60867 10.2333 2.69133 10.2886 2.85733L10.3533 3.05133C10.4378 3.33218 10.6125 3.57734 10.8504 3.74884C11.0883 3.92034 11.3761 4.00862 11.6693 4"
                                stroke="#808080" />
                        </svg></span>
                </div>
      <div class="col-12 col-md-3">                        
                        <select class="form-select form-control" name="dashboardUrls[][input_format]" required>
                            <option value="" disabled selected hidden>Selecionar</option>
                            <option value="PWBI">PWBI</option>
                            <option value="Tableu">Tableu</option>
                            <option value="Looker">Looker</option>
                            <option value="Figma">Figma</option>
                               
                            <option value="URL Genérica">URL Genérica</option>    
                            <option value="Python">Python</option>    
                            <option value="Bloco">Bloco</option>    
                            <option value="API">API</option>    
                        </select>
                        </div>
                        <div class="col-12 col-md-3">        
                            <input class="form-control" type="text" name="dashboardUrls[][url_dashboard]" required>
                        </div>
                        <div class="col-12 col-md-3">     
                            <input class="form-control" type="text" name="dashboardUrls[][dispositivo]" required>
                        </div>                        
                        <span class="svg-remove-desktop" style="cursor: pointer; flex: 0 0 auto;width: 25%;margin:0; padding:0;align-self: center;" onclick="removeUrlField(this)">                                       
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path d="M13.6693 4H2.33594M12.5579 5.66667L12.2513 10.2667C12.1333 12.036 12.0746 12.9207 11.4979 13.46C10.9213 14 10.0339 14 8.2606 14H7.7446C5.97127 14 5.08394 14 4.50727 13.46C3.9306 12.9207 3.87127 12.036 3.75394 10.2667L3.44727 5.66667M6.33594 7.33333L6.66927 10.6667M9.66927 7.33333L9.33594 10.6667" stroke="#808080" stroke-linecap="round"/>
        <path d="M4.33594 4H4.40927C4.67757 3.99314 4.93755 3.90548 5.15522 3.74847C5.37289 3.59147 5.53811 3.37243 5.62927 3.12L5.65194 3.05133L5.7166 2.85733C5.77194 2.69133 5.79994 2.60867 5.8366 2.538C5.90874 2.39959 6.01228 2.27999 6.13892 2.18877C6.26557 2.09755 6.41181 2.03724 6.56594 2.01267C6.64394 2 6.73127 2 6.90594 2H9.09927C9.27394 2 9.36127 2 9.43927 2.01267C9.5934 2.03724 9.73964 2.09755 9.86629 2.18877C9.99293 2.27999 10.0965 2.39959 10.1686 2.538C10.2053 2.60867 10.2333 2.69133 10.2886 2.85733L10.3533 3.05133C10.4378 3.33218 10.6125 3.57734 10.8504 3.74884C11.0883 3.92034 11.3761 4.00862 11.6693 4" stroke="#808080"/>
        </svg></span>
    `;
            urlFields.appendChild(newUrlField);
            updateModalValues();

            // Verifica se já existem 3 filhos nós
            if (urlFields.children.length >= 3) {
                addUrlFieldButton.disabled = true;
                return; // Impede a adição de mais campos
            }
        });









        //submit form
        submitButton.addEventListener('click', function (event) {
            updateModalValues();
            confirmModal.style.display = 'block'
        })

        function updateModalValues() {
            const nodes = urlFields.getElementsByClassName('row');

            for (let i = 0; i < nodes.length; i++) {
                const node = nodes[i];
                const inputFormat = node.querySelector('select[name="dashboardUrls[][input_format]"]').value;
                const urlDashboard = node.querySelector('input[name="dashboardUrls[][url_dashboard]"]').value;
                const dispositivo = node.querySelector('input[name="dashboardUrls[][dispositivo]"]').value;

                const modalInputFormat = confirmModal.querySelector(`#displayInputFormat${i + 1}`);
                const modalUrlDashboard = confirmModal.querySelector(`#displayUrlDashboard${i + 1}`);
                const modalDispositivo = confirmModal.querySelector(`#displayDispositivo${i + 1}`);

                modalInputFormat.style.display = 'block';
                modalUrlDashboard.style.display = 'block';
                modalDispositivo.style.display = 'block';

                modalInputFormat.value = `${inputFormat}`;
                modalUrlDashboard.value = `${urlDashboard}`;
                modalDispositivo.value = `${dispositivo}`;
            }
        }

        btnConfirmSend.addEventListener('click', () => {
            confirmModal.style.display = 'none'
            btnSubmitForm.click();
        })

        btnCancelModall.addEventListener('click', () => {
            confirmModal.style.display = 'none'

        })


    });
    function removeUrlField(element) {
        const urlFields = document.getElementById('urlFields');
        urlFields.removeChild(element.parentElement); // Remove o elemento pai
        const addUrlFieldButton = document.getElementById('addUrlField');
        addUrlFieldButton.disabled = false; // Habilita o botão de adição
        updateModalValues();
    }

</script>

<!--
<script>
    document.addEventListener('DOMContentLoaded', function () {
    // ...

    // Adicione um identificador ao botão "Enviar" no formulário
    const submitButton = document.getElementById('send-dashbord');

    // Adicione um manipulador de evento para o botão "Enviar"
    submitButton.addEventListener('click', function (event) {
        // Coleta os valores dos campos dashboardUrls
        const dashboardUrlElements = document.querySelectorAll('[name^="dashboardUrls["]');
        const numDashboardUrls = Math.min(dashboardUrlElements.length, 3);

        // Limpa os campos exibidos no modal
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`displayInputFormat${i}`).textContent = '';
            document.getElementById(`displayUrlDashboard${i}`).textContent = '';
            document.getElementById(`displayDispositivo${i}`).textContent = '';
        }

        // Exibe os valores nos elementos do modal
        for (let i = 0; i < numDashboardUrls; i++) {
            const inputFormat = dashboardUrlElements[i].querySelector('[name$="[input_format]"]').value;
            const urlDashboard = dashboardUrlElements[i].querySelector('[name$="[url_dashboard]"]').value;
            const dispositivo = dashboardUrlElements[i].querySelector('[name$="[dispositivo]"]').value;

            document.getElementById(`displayInputFormat${i + 1}`).textContent = inputFormat;
            document.getElementById(`displayUrlDashboard${i + 1}`).textContent = urlDashboard;
            document.getElementById(`displayDispositivo${i + 1}`).textContent = dispositivo;
        }

        // Abre o modal de confirmação
        openConfirmationModal();

       
    });

    // ...
});

</script>
-->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('customer').addEventListener('change', function () {
            const selectedCustomer = this.value;

            // Enviar solicitação para buscar os dashboards relacionados
            fetch(`/projects/get-projects/${selectedCustomer}`)
                .then(response => response.json())
                .then(data => {

                    // Atualize o campo "dashboard_permissions" com as opções de dashboards disponíveis
                    const projectsSelect = document.getElementById('project');
                    projectsSelect.innerHTML = '';

                    if (data.length > 0) {

                        data.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.id_project;
                            option.textContent = project.nam_project; // Altere para o campo apropriado do seu dashboard

                            projectsSelect.appendChild(option);
                        })
                    } else {

                        const option = document.createElement('option');
                        option.value = ""
                        option.textContent = "Nenhum projeto cadastrado"

                        projectsSelect.appendChild(option);
                    }

                })
                .catch(error => {
                    console.error('Erro ao buscar dashboards:', error);
                });
        });
    });
</script>